/*!
 * LetsBlog
 * Article form - v1.0.0 (2015-02-26T09:36:16+0800)
 * Released under MIT license
 */
define("/adminpage/article-form/1.x/",["dom/1.1.x/","ajax/1.1.x/","tmpl/2.1.x/","dom/1.0.x/","widget/1.0.x/","validator/1.0.x/",null],function(e){"use strict";function t(e){var t=f[e];t&&(t.abort(),f[e]=null)}var a=e("base/1.0.x/"),n=e("dom/1.1.x/"),i=e("ajax/1.1.x/"),r=e("tmpl/2.1.x/"),s=e("validator/1.0.x/"),l=window.CKEDITOR;window.onbeforeunload=function(){return"确定要离开此页面？"};var o=Number(n("input[name=articleid]").val())>0;new s({form:n("#article-form"),steps:[{fields:"title",message:"请填写标题"},{fields:"title_en",message:"英文标题只能包含英文、数字和中划线",rule:function(e){return/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(e)},required:!1},{fields:"categoryid",message:"请选择分类"}],events:a.extend({beforesubmit:function(){n("textarea[name=content]").val(l.instances.content.getData())}},s.defaultOptions.events),submitProxy:function(e,t){var a=n("#submit-btn"),r=a.val();a.prop("disabled",!0).val("提交中..."),i.send({url:t.attr("action"),data:e,dataType:"json",method:"POST",onsuccess:function(e){1===e.status?o?alert("保存成功"):(o=!0,n("input[name=articleid]").val(e.data.articleid),t.attr("action","update/"+e.data.articleid),n("#form-item-update-pubtime").show(),alert("发布成功，您可以继续编辑文章")):alert(e.message)},onerror:function(){alert("发布失败")},oncomplete:function(){a.prop("disabled",!1).val(r)}})}});var d=new r({UPLOADING:'<p data-taskid="<%=taskId%>">正在上传 <%=fileName%> ... <a href="#" class="upload-cancel">取消</a></p>',UPLOAD_FAIL:'<%=fileName%> 上传失败：<em class="upload-result-message"><%=message%></em>',UPLOAD_SUCCESS:'<%=fileName%> 已被上传到<em class="upload-result-path"><%=path%></em>(<a href="#" class="upload-result-insertlink">插入为链接</a><% if (isImage) { %> <a href="#" class="upload-result-insertimg">插入为图片</a><% } %>)',INSERT_LINK:'<a href="<%=path%>" target="_blank"><%=text%></a>',INSERT_IMG:'<img src="<%=path%>" alt="<%=alt%>" />'}),u=n("#upload-panel"),p=u.find("input[type=file]"),c=u.find(".upload-result"),f=[];c.on("click",function(e){e.preventDefault();var a=n(this),i=a.data("confirmTimer");if(i){clearTimeout(i);var r=a.parent();t(r.attr("data-taskid")),r.remove()}else a.text("确定？"),a.data("confirmTimer",setTimeout(function(){a.text("取消").removeData("confirmTimer")},3e3))},{delegator:".upload-cancel"}),c.on("click",function(e){e.preventDefault();var t=window.prompt("请输入链接文字");t&&l.instances.content.insertHtml(d.render("INSERT_LINK",{text:t,path:n(this).siblings().filter(".upload-result-path").text()}))},{delegator:".upload-result-insertlink"}),c.on("click",function(e){e.preventDefault(),l.instances.content.insertHtml(d.render("INSERT_IMG",{alt:window.prompt("请输入图片说明")||"",path:n(this).siblings().filter(".upload-result-path").text()}))},{delegator:".upload-result-insertimg"}),p.change(function(){if(this.files.length){var e=this.files[0];if(!e.size)return void alert("不能上传空文件");if(e.size>3145728)return void alert("文件不能大于3MB");var t=e.name,a=t.split("."),n=a.length>1?a[a.length-1].toLowerCase():null,i=new FormData;i.append("file",e);var r=new XMLHttpRequest,s=f.push(r)-1;r.open("POST","/admin/article/upload"),r.onreadystatechange=function(){if(4==this.readyState){f[s]=null;var e;if(200==this.status){var a=JSON.parse(this.responseText);1!==a.status&&(e=a.message)}else e="状态码"+this.status;var i=c.find("p[data-taskid="+s+"]").empty();i.html(e?d.render("UPLOAD_FAIL",{fileName:t,message:e}):d.render("UPLOAD_SUCCESS",{fileName:t,path:a.data.path,isImage:-1!==["jpg","jpeg","png","gif","bmp"].indexOf(n)}))}},r.send(i),c.append(d.render("UPLOADING",{fileName:t,taskId:s}))}}),u.find("input.upload-button").click(function(){p.click()})});