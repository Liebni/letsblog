/*!
 * LetsBlog
 * Article form - v1.1 (2016-02-11T15:50:08+0800)
 * Released under MIT license
 */
define("/adminpage/article__form/1.x/article__form",["dom/1.1.x/","ajax/1.2.x/","tmpl/2.1.x/","widget/1.1.x/","validator/1.1.x/"],function(e,t,a){"use strict";function n(e){var t=h[e];t&&(t.abort(),h[e]=null)}var i=e("base/1.1.x/"),r=e("dom/1.1.x/"),s=e("ajax/1.2.x/"),l=e("tmpl/2.1.x/"),o=e("validator/1.1.x/"),d=window.CKEDITOR;window.onbeforeunload=function(){return"确定要离开此页面？"};var u=Number(r("input[name=articleid]").val())>0;new o({form:r("#article-form"),steps:[{fields:"title",message:"请填写标题"},{fields:"title_en",message:"英文标题只能包含英文、数字和中划线",rule:function(e){return/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(e)},required:!1},{fields:"categoryid",message:"请选择分类"}],events:i.extend({beforesubmit:function(){r("textarea[name=content]").val(d.instances.content.getData())}},o.defaultOptions.events),submitProxy:function(e,t){var a=r("#submit-btn"),n=a.val();a.prop("disabled",!0).val("提交中..."),s.send({url:t.attr("action"),data:e,dataType:"json",method:"POST",onsuccess:function(e){1===e.status?u?alert("保存成功"):(u=!0,r("input[name=articleid]").val(e.data.articleid),t.attr("action","/admin/article/update/"+e.data.articleid+"/post"),r("#form-item-update-pubtime").show(),alert("发布成功，您可以继续编辑文章")):alert(e.message)},onerror:function(){alert("发布失败")},oncomplete:function(){a.prop("disabled",!1).val(n)}})}});var p=new l({UPLOADING:'<p data-taskid="<%=taskId%>">正在上传 <%=fileName%> ... <a href="#" class="upload-cancel">取消</a></p>',UPLOAD_FAIL:'<%=fileName%> 上传失败：<em class="upload-result-message"><%=message%></em>',UPLOAD_SUCCESS:'<%=fileName%> 已被上传到<em class="upload-result-path"><%=path%></em>(<a href="#" class="upload-result-insertlink">插入为链接</a><% if (isImage) { %> <a href="#" class="upload-result-insertimg">插入为图片</a><% } %>)',INSERT_LINK:'<a href="<%=path%>" target="_blank"><%=text%></a>',INSERT_IMG:'<img src="<%=path%>" alt="<%=alt%>" />'}),c=r("#upload-panel"),m=c.find("input[type=file]"),f=c.find(".upload-result"),h=[];f.on("click",function(e){e.preventDefault();var t=r(this),a=t.data("confirmTimer");if(a){clearTimeout(a);var i=t.parent();n(i.attr("data-taskid")),i.remove()}else t.text("确定？"),t.data("confirmTimer",setTimeout(function(){t.text("取消").removeData("confirmTimer")},3e3))},{delegator:".upload-cancel"}),f.on("click",function(e){e.preventDefault();var t=window.prompt("请输入链接文字");t&&d.instances.content.insertHtml(p.render("INSERT_LINK",{text:t,path:r(this).siblings().filter(".upload-result-path").text()}))},{delegator:".upload-result-insertlink"}),f.on("click",function(e){e.preventDefault(),d.instances.content.insertHtml(p.render("INSERT_IMG",{alt:window.prompt("请输入图片说明")||"",path:r(this).siblings().filter(".upload-result-path").text()}))},{delegator:".upload-result-insertimg"}),m.change(function(e){if(this.files.length){var t=this.files[0];if(!t.size)return void alert("不能上传空文件");if(t.size>5242880)return void alert("文件不能大于5MB");var a=t.name,n=a.split("."),i=n.length>1?n[n.length-1].toLowerCase():null,r=new FormData;r.append("file",t);var s=new XMLHttpRequest,l=h.push(s)-1;s.open("POST","/admin/article/attachment/upload"),s.onreadystatechange=function(){if(4==this.readyState){h[l]=null;var e;if(200==this.status){var t=JSON.parse(this.responseText);1!==t.status&&(e=t.message)}else e="状态码"+this.status;var n=f.find("p[data-taskid="+l+"]").empty();e?n.html(p.render("UPLOAD_FAIL",{fileName:a,message:e})):n.html(p.render("UPLOAD_SUCCESS",{fileName:a,path:t.data.path,isImage:-1!==["jpg","jpeg","png","gif","bmp"].indexOf(i)}))}},s.send(r),f.append(p.render("UPLOADING",{fileName:a,taskId:l}))}}),c.find("input.upload-button").click(function(){m.click()})});