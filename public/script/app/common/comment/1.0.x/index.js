/*!
 * LetsBlog
 * Comment component - v1.0.0 (2015-03-08T11:24:20+0800)
 * Released under MIT license
 */
define("/common/comment/1.0.x/",["dom/1.1.x/","tmpl/2.1.x/","ajax/1.1.x/","widget/1.0.x/","paginator/1.1.x/","dom/1.0.x/","validator/1.0.x/"],function(e,t,s){"use strict";var a=e("dom/1.1.x/"),i=e("tmpl/2.1.x/"),n=e("ajax/1.1.x/"),r=e("widget/1.0.x/"),o=e("paginator/1.1.x/"),l=e("validator/1.0.x/"),m=window.currentUser,c=new i({LIST:'<% data.forEach(function(comment) { %><article class="comment__list__item<% if (comment.userid) { %> comment__list__item--isuser<% } %>"><header class="comment__list__item__header clearfix"><div class="comment__list__item__header__author"><em><%=comment.user_nickname%></em> 说：</div><div class="comment__list__item__header__pubtime">发表于<%=comment.pubtime_formatted%></div></header><div class="comment__list__item__content"><%-comment.content%></div></article><% }); %><% if (totalPages > 1) { %><nav class="comment__list__paginator"></nav><% } %>',TIPS:'<p class="comment__list__tips"><%=tips%></p>'});return r.create(function(){},{_init:function(e){var t=this,s=e.form;if(t._listWrapper=e.listWrapper,0==s.length)return void t.load(e.page);var i=[];m.userid||(i.push({fields:"user_nickname",message:"请填写昵称"}),i.push({fields:"user_nickname",rule:function(e){return e.length>=2},message:"昵称最少要有两个字"}),i.push({fields:"user_email",rule:"isEmail",message:"Email格式错误",required:!1}),i.push({fields:"user_qq",rule:"isQQ",message:"QQ号格式错误",required:!1}),s.find("input[type=text]").forEach(function(e){var t=localStorage.getItem(e.name);t&&(e.value=t)})),i.push({fields:"content",message:"请填写评论内容"}),t._validator=new l({form:s,steps:i,submitProxy:function(e,s){var i=s.find("input[type=submit]"),r=i.val();i.prop("disabled",!0).val(i.attr("data-submitingtext")),e.forEach(function(e){/^user_/.test(e.name)&&localStorage.setItem(e.name,e.value)}),n.send({url:"/comment/create",data:e,method:"POST",dataType:"json",onsuccess:function(e){if(1===e.status){if(e=e.data,e.lastComment.state){alert("发表成功"),t._destroyList(),t._renderList(e.commentList,e.page,e.totalPages);var i=t._listWrapper.find(".comment__list__item").last();window.scrollTo(a(window).scrollLeft(),i.offset().top+i.outerHeight(!0)+a("#header").innerHeight()-document.documentElement.clientHeight),t.trigger("submitsuccess",{result:e})}else alert("您发表的评论需经过审核才会显示");s.find("textarea[name=content]").val("")}else alert(e.message)},oncomplete:function(){i.prop("disabled",!1).val(r)}})}}),t.load(e.page)},_destroy:function(){this._destroyList(),this._validator.destroy(),delete this._validator},_destroyList:function(){this._paginator&&(this._paginator.destroy(),delete this._paginator),this._listWrapper.empty()},_renderList:function(e,t,s){var n=this,r=n._listWrapper;e.forEach(function(e){e.content=i.escape(e.content).replace(/\r\n/g,"<br />").replace(/[\r\n]/g,"<br />")}),r.html(c.render("LIST",{data:e,totalPages:s})),s>1&&(n._paginator=new o({wrapper:r.find(".comment__list__paginator"),currentPage:t,totalPages:s,prevText:"",nextText:"",ellipsisText:"",numberOfPagesToShow:3,events:{click:function(e){n.load(e.page,!0),window.scrollTo(a(window).scrollLeft(),r.parent().offset().top-a("#header").innerHeight())}}}))},load:function(e){var t=this,s=t._options.listWrapper;t._destroyList(),s.html(c.render("TIPS",{tips:"正在加载评论..."})),n.send("/comment/list/"+this._options.articleId,{data:{page:e},dataType:"json",onsuccess:function(e){1===e.status?(e=e.data,e&&e.totalPages?t._renderList(e.commentList,e.page,e.totalPages):s.html(c.render("TIPS",{tips:"暂无评论"}))):s.html(c.render("TIPS",{tips:e.message}))}})}})});