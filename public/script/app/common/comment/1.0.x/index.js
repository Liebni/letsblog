/*!
 * LetsBlog
 * Comment component - v1.0.0 (2015-03-08T11:24:20+0800)
 * Released under MIT license
 */
define("/common/comment/1.0.x/",["dom/1.1.x/","tmpl/2.1.x/","ajax/1.1.x/","widget/1.0.x/","paginator/1.1.x/","dom/1.0.x/","validator/1.0.x/",null],function(e){"use strict";var t=e("dom/1.1.x/"),s=e("tmpl/2.1.x/"),a=e("ajax/1.1.x/"),i=e("widget/1.0.x/"),n=e("paginator/1.1.x/"),r=e("validator/1.0.x/"),o=window.currentUser,l=new s({LIST:'<% data.forEach(function(comment) { %><article class="comment__list__item<% if (comment.userid) { %> comment__list__item--isuser<% } %>"><header class="comment__list__item__header clearfix"><div class="comment__list__item__header__author"><em><%=comment.user_nickname%></em> 说：</div><div class="comment__list__item__header__pubtime">发表于<%=comment.pubtime_formatted%></div></header><div class="comment__list__item__content"><%-comment.content%></div></article><% }); %><% if (totalPages > 1) { %><nav class="comment__list__paginator"></nav><% } %>',TIPS:'<p class="comment__list__tips"><%=tips%></p>'});return i.create(function(){},{_init:function(e){var s=this,i=e.form;if(s._listWrapper=e.listWrapper,0==i.length)return void s.load(e.page);var n=[];o.userid||(n.push({fields:"user_nickname",message:"请填写昵称"}),n.push({fields:"user_nickname",rule:function(e){return e.length>=2},message:"昵称最少要有两个字"}),n.push({fields:"user_email",rule:"isEmail",message:"Email格式错误",required:!1}),n.push({fields:"user_qq",rule:"isQQ",message:"QQ号格式错误",required:!1}),i.find("input[type=text]").forEach(function(e){var t=localStorage.getItem(e.name);t&&(e.value=t)})),n.push({fields:"content",message:"请填写评论内容"}),s._validator=new r({form:i,steps:n,submitProxy:function(e,i){var n=i.find("input[type=submit]"),r=n.val();n.prop("disabled",!0).val(n.attr("data-submitingtext")),e.forEach(function(e){/^user_/.test(e.name)&&localStorage.setItem(e.name,e.value)}),a.send({url:"/comment/create",data:e,method:"POST",dataType:"json",onsuccess:function(e){if(1===e.status){if(e=e.data,e.lastComment.state){alert("发表成功"),s._destroyList(),s._renderList(e.commentList,e.page,e.totalPages);var a=s._listWrapper.find(".comment__list__item").last();window.scrollTo(t(window).scrollLeft(),a.offset().top+a.outerHeight(!0)+t("#header").innerHeight()-document.documentElement.clientHeight),s.trigger("submitsuccess",{result:e})}else alert("您发表的评论需经过审核才会显示");i.find("textarea[name=content]").val("")}else alert(e.message)},oncomplete:function(){n.prop("disabled",!1).val(r)}})}}),s.load(e.page)},_destroy:function(){this._destroyList(),this._validator.destroy(),delete this._validator},_destroyList:function(){this._paginator&&(this._paginator.destroy(),delete this._paginator),this._listWrapper.empty()},_renderList:function(e,a,i){var r=this,o=r._listWrapper;e.forEach(function(e){e.content=s.escape(e.content).replace(/\r\n/g,"<br />").replace(/[\r\n]/g,"<br />")}),o.html(l.render("LIST",{data:e,totalPages:i})),i>1&&(r._paginator=new n({wrapper:o.find(".comment__list__paginator"),currentPage:a,totalPages:i,prevText:"",nextText:"",ellipsisText:"",numberOfPagesToShow:3,events:{click:function(e){r.load(e.page,!0),window.scrollTo(t(window).scrollLeft(),o.parent().offset().top-t("#header").innerHeight())}}}))},load:function(e){var t=this,s=t._options.listWrapper;t._destroyList(),s.html(l.render("TIPS",{tips:"正在加载评论..."})),a.send("/comment/list/"+this._options.articleId,{data:{page:e},dataType:"json",onsuccess:function(e){1===e.status?(e=e.data,e&&e.totalPages?t._renderList(e.commentList,e.page,e.totalPages):s.html(l.render("TIPS",{tips:"暂无评论"}))):s.html(l.render("TIPS",{tips:e.message}))}})}})});